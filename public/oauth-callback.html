<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .callback-content {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .spinner {
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="callback-content">
        <svg class="spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
        <h2>Completing Discord Login...</h2>
        <p>You can close this window once authentication is complete.</p>
    </div>

    <script type="module">
        // Import Supabase from CDN for the callback page
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Use the same config as the main app
        const SUPABASE_CONFIG = {
            url: 'https://nonfjkoaxdnyiuanmyzb.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vbmZqa29heGRueWl1YW5teXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NjkxMzQsImV4cCI6MjA2OTU0NTEzNH0.SIt7zlEMTHb-B0DKXHWkoYxZUJzDV-c11cRsSA0puOM'
        };

        const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        // Handle the OAuth callback
        async function handleCallback() {
            try {
                console.log('OAuth callback page loaded');
                
                // Get the session from the URL fragments
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Error getting session:', error);
                    window.opener?.postMessage({ 
                        type: 'SUPABASE_AUTH_ERROR', 
                        error: error.message 
                    }, '*');
                    return;
                }

                if (data.session) {
                    console.log('Session found, posting to opener');
                    // Post session to the opener (iframe)
                    window.opener?.postMessage({ 
                        type: 'SUPABASE_SESSION', 
                        session: data.session 
                    }, '*');
                    
                    // Close the popup after a brief delay
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    console.log('No session found, waiting for auth state change');
                    // If no immediate session, listen for auth state changes
                    const { data: authListener } = supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('Auth state change:', event, session);
                        
                        if (event === 'SIGNED_IN' && session) {
                            console.log('Signed in, posting session to opener');
                            window.opener?.postMessage({ 
                                type: 'SUPABASE_SESSION', 
                                session: session 
                            }, '*');
                            
                            // Unsubscribe and close
                            authListener.subscription.unsubscribe();
                            setTimeout(() => {
                                window.close();
                            }, 1000);
                        }
                    });

                    // Timeout fallback - close popup after 30 seconds if nothing happens
                    setTimeout(() => {
                        console.log('Timeout reached, closing popup');
                        window.opener?.postMessage({ 
                            type: 'SUPABASE_AUTH_TIMEOUT' 
                        }, '*');
                        window.close();
                    }, 30000);
                }
            } catch (error) {
                console.error('Callback error:', error);
                window.opener?.postMessage({ 
                    type: 'SUPABASE_AUTH_ERROR', 
                    error: error.message 
                }, '*');
                window.close();
            }
        }

        // Start the callback handling when page loads
        handleCallback();
    </script>
</body>
</html>
